<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Snake - Ernesto Josiah</title>
    <style>
        body { 
            background: #000; color: gold; text-align: center; 
            font-family: sans-serif; margin: 0; padding: 0;
            overflow: hidden; touch-action: none; 
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        canvas { 
            border: 2px solid gold; background: #000; 
            max-width: 95%; max-height: 40vh; margin: 10px auto;
            flex-shrink: 0;
        }

        #mobile-controls {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding-bottom: 20px;
            position: relative;
            z-index: 9999 !important;
        }

        .row { display: flex; gap: 20px; }

        .btn {
            width: 80px; height: 80px; 
            background: #222; border: 4px solid gold; border-radius: 50%; 
            color: gold; font-size: 35px;
            display: flex; justify-content: center; align-items: center;
            touch-action: none !important;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            /* Suavizamos el cambio de color */
            transition: background 0.1s, transform 0.1s;
        }

        /* Efecto visual de pulsado */
        .btn:active { 
            background: #444; 
            color: #fff; 
            transform: scale(0.9);
            border-color: #fff;
        }

        @media (pointer: fine) and (min-width: 1024px) {
            #mobile-controls { display: none; }
            canvas { max-height: 80vh; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>SNAKE MULTIPLAYER</h1>
        <div id="status">Cargando Arena...</div>
        
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div id="mobile-controls">
            <div class="row">
                <div class="btn" id="btn-up">▲</div>
            </div>
            <div class="row">
                <div class="btn" id="btn-left">◀</div>
                <div class="btn" id="btn-right">▶</div>
            </div>
            <div class="row">
                <div class="btn" id="btn-down">▼</div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="snake.js"></script>

    <script>
        function conectarYa() {
            const botones = [
                { id: 'btn-up', dir: 'UP' },
                { id: 'btn-down', dir: 'DOWN' },
                { id: 'btn-left', dir: 'LEFT' },
                { id: 'btn-right', dir: 'RIGHT' }
            ];

            botones.forEach(b => {
                const el = document.getElementById(b.id);
                
                const accion = (e) => {
                    e.preventDefault();
                    
                    // SOLUCIÓN AL PELIGRO: Centralizamos la lógica
                    // Primero intentamos usar la función que tiene el bloqueo de 180 grados
                    if (typeof window.enviarMovimiento === "function") {
                        window.enviarMovimiento(b.dir);
                    } 
                    // Si por alguna razón la función no existe pero el socket sí, enviamos directo
                    else if (window.socket && window.socket.connected) {
                        window.socket.emit('movimiento', { dir: b.dir });
                    }
                    
                    console.log("Comando enviado: " + b.dir);
                };

                // Eventos de entrada
                el.addEventListener('touchstart', accion, { passive: false });
                el.addEventListener('mousedown', accion);
            });
            
            document.getElementById('status').innerText = "CONTROLES ACTIVOS";
        }

        // Verificador inteligente de carga
        const checkInterval = setInterval(() => {
            // Verificamos que el socket esté conectado Y el script cargado
            if (window.socket && window.socket.connected) {
                conectarYa();
                clearInterval(checkInterval);
            }
        }, 300);
    </script>
</body>
</html>
